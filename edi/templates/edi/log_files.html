{% extends 'edi/base.html' %}
{% block title %}–õ–æ–≥-—Ñ–∞–π–ª—ã ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}–õ–æ–≥-—Ñ–∞–π–ª—ã{% endblock %}
{% block page_sub %}{{ logs_dir }}{% endblock %}

{% block topbar_actions %}
<button class="btn btn-secondary btn-sm" onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
<a href="?file={{ selected }}&lines=500" class="btn btn-secondary btn-sm">500 —Å—Ç—Ä–æ–∫</a>
<a href="?file={{ selected }}&lines=1000" class="btn btn-secondary btn-sm">1000 —Å—Ç—Ä–æ–∫</a>
{% endblock %}

{% block content %}
<style>
  .log-layout { display:grid; grid-template-columns:220px 1fr; gap:16px; height:calc(100vh - 140px); }

  .log-sidebar { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; display:flex; flex-direction:column; }
  .log-sidebar-head { padding:12px 14px; border-bottom:1px solid var(--border); font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; }
  .log-file-item { display:flex; flex-direction:column; padding:10px 14px; border-bottom:1px solid var(--border); text-decoration:none; transition:background .1s; cursor:pointer; }
  .log-file-item:hover { background:var(--surface2); }
  .log-file-item.active { background:rgba(59,130,246,.1); border-left:3px solid var(--accent); }
  .log-file-name { font-size:12px; font-weight:600; color:var(--text); }
  .log-file-size { font-size:10px; color:var(--muted); margin-top:2px; }

  .log-content-wrap { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; display:flex; flex-direction:column; }
  .log-content-head { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  .log-content-head h3 { font-size:13px; font-weight:600; margin:0; }
  .log-meta { font-size:11px; color:var(--muted); }

  #log-output {
    flex:1; overflow-y:auto; padding:12px 16px;
    font-family:'IBM Plex Mono', monospace; font-size:11px; line-height:1.7;
    white-space:pre-wrap; word-break:break-all;
    color:var(--text2);
  }

  /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —É—Ä–æ–≤–Ω–µ–π */
  .ll-error  { color:#EF4444; }
  .ll-warn   { color:#F59E0B; }
  .ll-info   { color:#10B981; }
  .ll-debug  { color:#94A3B8; }

  .log-empty { text-align:center; padding:48px; color:var(--muted); }
</style>

<div class="log-layout">

  <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º —Ñ–∞–π–ª–æ–≤ -->
  <div class="log-sidebar">
    <div class="log-sidebar-head">üìÅ –§–∞–π–ª—ã –ª–æ–≥–æ–≤</div>
    {% for f in available %}
    <a class="log-file-item {% if f.name == selected %}active{% endif %}"
       href="?file={{ f.name }}&lines={{ lines }}">
      <span class="log-file-name">{{ f.name }}</span>
      <span class="log-file-size">{{ f.size_kb }} KB</span>
    </a>
    {% empty %}
    <div style="padding:20px;color:var(--muted);font-size:12px;text-align:center">
      –õ–æ–≥-—Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.<br>–û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ü–∏–∫–ª–∞ –ø–æ–ª–ª–∏–Ω–≥–∞.
    </div>
    {% endfor %}
  </div>

  <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ -->
  <div class="log-content-wrap">
    <div class="log-content-head">
      <h3>{{ selected }}</h3>
      <span class="log-meta">–ü–æ—Å–ª–µ–¥–Ω–∏–µ {{ lines }} —Å—Ç—Ä–æ–∫ ¬∑ {{ file_size }} KB</span>
    </div>
    {% if content %}
    <div id="log-output">{{ content }}</div>
    {% else %}
    <div class="log-empty">
      <div style="font-size:36px;margin-bottom:10px">üìã</div>
      <p>–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω</p>
    </div>
    {% endif %}
  </div>

</div>

<script>
// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –∫–æ–Ω—Ü–∞
const out = document.getElementById('log-output');
if (out) {
  out.scrollTop = out.scrollHeight;

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —É—Ä–æ–≤–Ω–µ–π –ª–æ–≥–æ–≤
  out.innerHTML = out.innerHTML
    .replace(/\[(ERROR)\]/g,   '<span class="ll-error">[$1]</span>')
    .replace(/\[(WARNING)\]/g, '<span class="ll-warn">[$1]</span>')
    .replace(/\[(INFO)\]/g,    '<span class="ll-info">[$1]</span>')
    .replace(/\[(DEBUG)\]/g,   '<span class="ll-debug">[$1]</span>');
}

// –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫
let autoRefresh = false;
document.addEventListener('keydown', e => {
  if (e.key === 'r' && !e.ctrlKey) {
    autoRefresh = !autoRefresh;
    console.log('Auto-refresh:', autoRefresh);
  }
});
</script>
{% endblock %}
