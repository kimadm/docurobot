{% extends 'edi/base.html' %}
{% block title %}{{ doc }} ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}{{ doc.get_doc_type_display }} ‚Ññ{{ doc.number }}{% endblock %}
{% block page_sub %}Docrobot ID: {{ doc.docrobot_id }}{% endblock %}

{% block topbar_actions %}
{% if queue and queue.status != 'sent' %}
<button class="btn btn-warn" onclick="retryQueue({{ queue.id }}, this)">‚Ü∫ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É</button>
{% endif %}
{% if queue and queue.status == 'failed' or not queue %}
<button class="btn btn-primary" onclick="sendDoc({{ doc.pk }}, this)">‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ 1–°</button>
{% endif %}
{% endblock %}

{% block content %}
<div class="detail-grid">

  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + XML -->
  <div style="display:flex;flex-direction:column;gap:16px;">

    <!-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ -->
    <div class="card">
      <div class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ</div>
      <table class="meta-table" style="width:100%">
        <tr><td>–¢–∏–ø</td><td><span class="badge badge-{{ doc.doc_type }}">{{ doc.get_doc_type_display }}</span></td></tr>
        <tr><td>–ù–æ–º–µ—Ä</td><td class="td-mono">{{ doc.number|default:"‚Äî" }}</td></tr>
        <tr><td>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</td><td class="td-mono">{{ doc.doc_date|default:"‚Äî" }}</td></tr>
        <tr><td>–ü–æ–ª—É—á–µ–Ω</td><td class="td-mono">{{ doc.received_at|date:"d.m.Y H:i:s" }}</td></tr>
        <tr><td>–ü–æ—Å—Ç–∞–≤—â–∏–∫ (GLN)</td><td class="td-mono">{{ doc.supplier_name }} <span style="color:var(--text3)">[{{ doc.supplier_gln }}]</span></td></tr>
        <tr><td>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å (GLN)</td><td class="td-mono">{{ doc.buyer_name }} <span style="color:var(--text3)">[{{ doc.buyer_gln }}]</span></td></tr>
        <tr><td>Docrobot ID</td><td class="td-mono" style="font-size:10px;">{{ doc.docrobot_id }}</td></tr>
      </table>
    </div>

    <!-- XML-–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="card">
      <div class="flex-between mb16">
        <div class="card-title" style="margin:0">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π XML</div>
        <button class="btn btn-secondary btn-sm" onclick="copyXml()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      {% if doc.xml_content %}
      <div class="code-block" id="xml-content">{{ doc.xml_content }}</div>
      {% else %}
      <div class="empty"><div class="empty-icon">üìÑ</div><p>XML –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω</p></div>
      {% endif %}
    </div>

    <!-- –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Docrobot -->
    <div class="card">
      <div class="card-title">–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ Docrobot (JSON)</div>
      <div class="code-block" style="color:#86efac;">{{ doc.raw_json|json_dumps }}</div>
    </div>

  </div>

  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –æ—á–µ—Ä–µ–¥—å + –ª–æ–≥–∏ -->
  <div style="display:flex;flex-direction:column;gap:16px;">

    <!-- –°—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏ -->
    <div class="card">
      <div class="card-title">–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ 1–°</div>
      {% if queue %}
      <div style="margin-bottom:12px;">
        <span class="badge badge-{{ queue.status }}" style="font-size:13px;padding:4px 12px;">{{ queue.get_status_display }}</span>
      </div>
      <table class="meta-table" style="width:100%">
        <tr><td>–ü–æ–ø—ã—Ç–æ–∫</td><td class="td-mono">{{ queue.attempts }}</td></tr>
        <tr><td>–°–æ–∑–¥–∞–Ω</td><td class="td-mono">{{ queue.created_at|date:"d.m.Y H:i" }}</td></tr>
        <tr><td>–û–±–Ω–æ–≤–ª—ë–Ω</td><td class="td-mono">{{ queue.updated_at|date:"d.m.Y H:i" }}</td></tr>
        {% if queue.sent_at %}
        <tr><td>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</td><td class="td-mono" style="color:var(--accent2)">{{ queue.sent_at|date:"d.m.Y H:i" }}</td></tr>
        {% endif %}
        {% if queue.http_status %}
        <tr><td>HTTP-–∫–æ–¥</td><td class="td-mono">{{ queue.http_status }}</td></tr>
        {% endif %}
        {% if queue.next_retry %}
        <tr><td>–°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞</td><td class="td-mono" style="color:var(--warn)">{{ queue.next_retry|date:"d.m H:i" }}</td></tr>
        {% endif %}
      </table>
      {% if queue.last_error %}
      <div style="margin-top:12px;padding:10px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:6px;font-size:12px;color:var(--danger);font-family:var(--mono);">
        {{ queue.last_error }}
      </div>
      {% endif %}
      {% if queue.response %}
      <div style="margin-top:10px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px;">–û—Ç–≤–µ—Ç 1–°:</div>
        <div class="code-block" style="max-height:120px;">{{ queue.response }}</div>
      </div>
      {% endif %}
      {% else %}
      <div style="color:var(--text3);font-size:13px;">–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å</div>
      {% endif %}
    </div>

    <!-- –õ–æ–≥–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
    <div class="card">
      <div class="card-title">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π</div>
      {% if logs %}
      {% for log in logs %}
      <div style="padding:8px 0;border-bottom:1px solid var(--border);">
        <div class="flex-between">
          <span class="badge badge-{% if log.level == 'error' %}error-lvl{% elif log.level == 'warn' %}warn{% else %}info{% endif %}" style="font-size:10px;">{{ log.action }}</span>
          <span class="td-mono" style="font-size:10px;">{{ log.created_at|date:"d.m H:i:s" }}</span>
        </div>
        <div style="font-size:12px;color:var(--text2);margin-top:4px;">{{ log.message }}</div>
      </div>
      {% endfor %}
      {% else %}
      <div style="color:var(--text3);font-size:13px;">–°–æ–±—ã—Ç–∏–π –Ω–µ—Ç</div>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyXml() {
  const text = document.getElementById('xml-content').textContent;
  navigator.clipboard.writeText(text).then(() => toast('XML —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success'));
}

async function sendDoc(id, btn) {
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const r = await fetch(`/api/send/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
    });
    const d = await r.json();
    if (d.success) {
      toast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      toast(`–û—à–∏–±–∫–∞: ${d.error}`, 'error');
      btn.disabled = false;
      btn.textContent = '‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ 1–°';
    }
  } catch(e) { toast('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', 'error'); btn.disabled = false; }
}
</script>

<!-- –§–∏–ª—å—Ç—Ä –¥–ª—è JSON -->
{% load edi_tags %}
{% endblock %}
