<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Docrobot EDI Gateway{% endblock %}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');

    :root {
      --bg:      #0b0f1a;
      --surface: #111827;
      --surface2:#1a2236;
      --surface3:#202d44;
      --border:  #1e2d45;
      --text:    #e2e8f0;
      --text2:   #94a3b8;
      --text3:   #4b6080;
      --muted:   #94a3b8;
      --accent:  #3b82f6;
      --accent2: #10b981;
      --warn:    #f59e0b;
      --danger:  #ef4444;
      --purple:  #8b5cf6;
      --mono:    'IBM Plex Mono', monospace;
      --sans:    'IBM Plex Sans', sans-serif;
      --nav-w:   220px;
      --radius:  8px;
    }

    html.light {
      --bg:      #f1f5f9;
      --surface: #ffffff;
      --surface2:#f8fafc;
      --surface3:#f1f5f9;
      --border:  #e2e8f0;
      --text:    #0f172a;
      --text2:   #475569;
      --text3:   #94a3b8;
      --muted:   #64748b;
      --accent:  #2563eb;
      --accent2: #059669;
      --warn:    #d97706;
      --danger:  #dc2626;
      --purple:  #7c3aed;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; display: flex; font-size: 14px; }

    /* ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ */
    .nav-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 150;
    }

    /* ‚îÄ‚îÄ –ù–∞–≤–∏–≥–∞—Ü–∏—è ‚îÄ‚îÄ */
    .nav {
      width: var(--nav-w); min-height: 100vh; background: var(--surface);
      border-right: 1px solid var(--border); display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; z-index: 200;
      transition: transform 0.28s cubic-bezier(.4,0,.2,1);
    }
    .nav-logo { padding: 20px 16px 16px; border-bottom: 1px solid var(--border); }
    .nav-logo-title { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--accent); letter-spacing: 0.08em; }
    .nav-logo-sub { font-size: 10px; color: var(--text3); margin-top: 2px; font-family: var(--mono); }
    .nav-items { flex: 1; padding: 12px 8px; overflow-y: auto; }
    .nav-section { margin-bottom: 16px; }
    .nav-label { font-size: 9px; font-weight: 600; letter-spacing: 0.12em; color: var(--text3); padding: 0 8px; margin-bottom: 4px; text-transform: uppercase; }
    .nav-item { display: flex; align-items: center; gap: 9px; padding: 8px 10px; border-radius: 6px; color: var(--text2); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; text-decoration: none; }
    .nav-item:hover { background: var(--surface2); color: var(--text); }
    .nav-item.active { background: rgba(59,130,246,0.15); color: var(--accent); }
    .nav-icon { font-size: 15px; width: 18px; text-align: center; flex-shrink: 0; }
    .nav-footer { padding: 12px 16px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text3); font-family: var(--mono); }

    /* ‚îÄ‚îÄ –ë—É—Ä–≥–µ—Ä ‚îÄ‚îÄ */
    .burger {
      display: none;
      width: 40px; height: 40px; border-radius: 8px;
      background: var(--surface2); border: 1px solid var(--border);
      cursor: pointer; align-items: center; justify-content: center;
      font-size: 22px; flex-shrink: 0; color: var(--text);
      padding: 0;
    }

    /* ‚îÄ‚îÄ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç ‚îÄ‚îÄ */
    .main { margin-left: var(--nav-w); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { padding: 14px 28px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .topbar-left { display: flex; align-items: center; gap: 12px; }
    .topbar-title { font-size: 16px; font-weight: 600; }
    .topbar-sub { font-size: 12px; color: var(--text3); margin-top: 1px; }
    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .content { padding: 24px 28px; flex: 1; }

    .theme-toggle { width: 36px; height: 36px; border-radius: 8px; background: var(--surface2); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: background .15s; flex-shrink: 0; }
    .theme-toggle:hover { background: var(--surface3); }

    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
    .card-title { font-size: 12px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent-color, var(--accent)); }
    .stat-label { font-size: 11px; color: var(--text3); font-weight: 500; text-transform: uppercase; letter-spacing: 0.06em; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--text); margin: 6px 0 2px; font-family: var(--mono); }
    .stat-value.green { color: var(--accent2); }
    .stat-value.blue  { color: var(--accent); }
    .stat-value.warn  { color: var(--warn); }
    .stat-value.red   { color: var(--danger); }

    .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .table-toolbar { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 10px 14px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text3); border-bottom: 1px solid var(--border); background: var(--surface2); }
    td { padding: 10px 14px; font-size: 13px; border-bottom: 1px solid rgba(30,45,69,0.6); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(30,45,69,0.4); }
    .td-mono { font-family: var(--mono); font-size: 11px; color: var(--text2); }

    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-pending  { background: rgba(148,163,184,0.12); color: var(--text2);   border: 1px solid rgba(148,163,184,0.2); }
    .badge-sending  { background: rgba(59,130,246,0.12);  color: var(--accent);  border: 1px solid rgba(59,130,246,0.2); }
    .badge-sent     { background: rgba(16,185,129,0.12);  color: var(--accent2); border: 1px solid rgba(16,185,129,0.2); }
    .badge-error    { background: rgba(245,158,11,0.12);  color: var(--warn);    border: 1px solid rgba(245,158,11,0.2); }
    .badge-failed   { background: rgba(239,68,68,0.12);   color: var(--danger);  border: 1px solid rgba(239,68,68,0.2); }
    .badge-ORDER    { background: rgba(59,130,246,0.12);  color: var(--accent);  border: 1px solid rgba(59,130,246,0.2); }
    .badge-ORDRSP   { background: rgba(139,92,246,0.12);  color: var(--purple);  border: 1px solid rgba(139,92,246,0.2); }
    .badge-DESADV   { background: rgba(245,158,11,0.12);  color: var(--warn);    border: 1px solid rgba(245,158,11,0.2); }
    .badge-INVOICE  { background: rgba(16,185,129,0.12);  color: var(--accent2); border: 1px solid rgba(16,185,129,0.2); }
    .badge-PRICAT   { background: rgba(148,163,184,0.12); color: var(--text2);   border: 1px solid rgba(148,163,184,0.2); }
    .badge-info     { background: rgba(59,130,246,0.12);  color: var(--accent); }
    .badge-warn     { background: rgba(245,158,11,0.12);  color: var(--warn); }
    .badge-error-lvl{ background: rgba(239,68,68,0.12);   color: var(--danger); }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: all 0.15s; font-family: var(--sans); }
    .btn-primary   { background: var(--accent);  color: #fff; border-color: var(--accent); }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: var(--surface2); color: var(--text2); border-color: var(--border); }
    .btn-secondary:hover { background: var(--surface3); color: var(--text); }
    .btn-success   { background: rgba(16,185,129,0.15); color: var(--accent2); border-color: rgba(16,185,129,0.3); }
    .btn-success:hover { background: rgba(16,185,129,0.25); }
    .btn-danger    { background: rgba(239,68,68,0.1);  color: var(--danger); border-color: rgba(239,68,68,0.3); }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }
    .btn-warn      { background: rgba(245,158,11,0.1); color: var(--warn);   border-color: rgba(245,158,11,0.3); }
    .btn-sm { padding: 4px 10px; font-size: 11px; }

    input[type=text], input[type=date], input[type=search], select, textarea {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); padding: 7px 10px; font-size: 12px; font-family: var(--sans);
      outline: none; transition: border-color 0.15s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }
    select option { background: var(--surface2); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .flex-row { display: flex; gap: 12px; align-items: center; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .mb16 { margin-bottom: 16px; }
    .mb24 { margin-bottom: 24px; }

    .code-block { background: #070c15; border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; font-family: var(--mono); font-size: 12px; color: #a5f3fc; overflow-x: auto; white-space: pre; max-height: 400px; overflow-y: auto; }

    #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; animation: slideIn 0.2s ease; min-width: 200px; }
    .toast-success { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: var(--accent2); }
    .toast-error   { background: rgba(239,68,68,0.15);  border: 1px solid rgba(239,68,68,0.3);  color: var(--danger); }
    .toast-info    { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); color: var(--accent); }
    @keyframes slideIn { from { transform: translateX(40px); opacity:0; } to { transform:none; opacity:1; } }

    .empty { padding: 40px; text-align: center; color: var(--text3); }
    .empty-icon { font-size: 36px; margin-bottom: 8px; }
    .detail-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    .meta-table td:first-child { color: var(--text3); width: 160px; font-size: 12px; }
    .meta-table td { padding: 6px 0; border: none; }
    .meta-table tr:hover td { background: none; }
    .chart-bar-wrap { display: flex; align-items: flex-end; gap: 4px; height: 80px; }
    .chart-bar-col { display: flex; flex-direction: column; align-items: center; flex: 1; gap: 4px; }
    .chart-bar { width: 100%; background: var(--accent); border-radius: 3px 3px 0 0; min-height: 2px; transition: background 0.2s; }
    .chart-bar:hover { background: #60a5fa; }
    .chart-label { font-size: 9px; color: var(--text3); }

    /* ‚îÄ‚îÄ –ú–æ–±–∏–ª—å–Ω—ã–µ ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .burger { display: flex; }
      .nav { transform: translateX(-100%); }
      .nav.open { transform: translateX(0); }
      .main { margin-left: 0; }
      .topbar { padding: 10px 14px; }
      .content { padding: 14px; }
      .detail-grid { grid-template-columns: 1fr; }
      .grid-2 { grid-template-columns: 1fr; }
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>

  <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ -->
  <div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="nav" id="mainNav">
    <div class="nav-logo">
      <div class="nav-logo-title">DOCROBOT EDI</div>
      <div class="nav-logo-sub">Gateway ‚Üí 1C</div>
    </div>
    <div class="nav-items">
      <div class="nav-section">
        <div class="nav-label">–û–±–∑–æ—Ä</div>
        <a href="{% url 'dashboard' %}" class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
          <span class="nav-icon">‚ñ¶</span> –î–∞—à–±–æ—Ä–¥
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-label">–î–æ–∫—É–º–µ–Ω—Ç—ã</div>
        <a href="{% url 'documents' %}" class="nav-item {% if 'document' in request.resolver_match.url_name %}active{% endif %}">
          <span class="nav-icon">üìÑ</span> –î–æ–∫—É–º–µ–Ω—Ç—ã
        </a>

      </div>
      <div class="nav-section">
        <div class="nav-label">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</div>
        <a href="{% url 'logs' %}" class="nav-item {% if request.resolver_match.url_name == 'logs' %}active{% endif %}">
          <span class="nav-icon">üìã</span> –õ–æ–≥–∏
        </a>
        <a href="{% url 'reports' %}" class="nav-item {% if request.resolver_match.url_name == 'reports' %}active{% endif %}">
          <span class="nav-icon">üìä</span> –û—Ç—á—ë—Ç—ã
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <a href="{% url 'daily_report' %}" class="nav-item {% if request.resolver_match.url_name == 'daily_report' %}active{% endif %}">
          <span class="nav-icon">üìà</span> –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç
        </a>
        <a href="{% url 'suppliers' %}" class="nav-item {% if request.resolver_match.url_name == 'suppliers' %}active{% endif %}">
          <span class="nav-icon">üè≠</span> –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏
        </a>
        <a href="{% url 'log_files' %}" class="nav-item {% if request.resolver_match.url_name == 'log_files' %}active{% endif %}">
          <span class="nav-icon">üìã</span> –õ–æ–≥-—Ñ–∞–π–ª—ã
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-label">–°–∏—Å—Ç–µ–º–∞</div>
        <a href="{% url 'healthcheck' %}" class="nav-item {% if request.resolver_match.url_name == 'healthcheck' %}active{% endif %}">
          <span class="nav-icon">ü©∫</span> –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
        </a>
        <a href="{% url 'connections' %}" class="nav-item {% if request.resolver_match.url_name == 'connections' %}active{% endif %}">
          <span class="nav-icon">üîå</span> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        </a>
        <a href="{% url 'settings' %}" class="nav-item {% if 'settings' in request.resolver_match.url_name %}active{% endif %}">
          <span class="nav-icon">üîß</span> –®–∞–±–ª–æ–Ω—ã XML
        </a>
        <a href="/admin/" class="nav-item">
          <span class="nav-icon">‚öô</span> Django Admin
        </a>
      </div>
    </div>
    <div class="nav-footer">v1.0 ¬∑ Docrobot KZ</div>
  </nav>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="burger" id="burgerBtn" onclick="openNav()">‚ò∞</button>
        <div>
          <div class="topbar-title">{% block page_title %}Docrobot EDI{% endblock %}</div>
          <div class="topbar-sub">{% block page_sub %}{% endblock %}</div>
        </div>
      </div>
      <div class="topbar-right">
        <button class="theme-toggle" id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É" onclick="toggleTheme()">üåô</button>
        {% block topbar_actions %}{% endblock %}
      </div>
    </div>
    <div class="content">
      {% block content %}{% endblock %}
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    function toast(msg, type = 'info') {
      const el = document.createElement('div');
      el.className = `toast toast-${type}`;
      el.textContent = msg;
      document.getElementById('toast-container').appendChild(el);
      setTimeout(() => el.remove(), 3500);
    }

    async function retryQueue(id, btn) {
      btn.disabled = true; btn.textContent = '...';
      try {
        const r = await fetch(`/api/retry/${id}/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
        const d = await r.json();
        if (d.success) { toast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 1–°', 'success'); setTimeout(() => location.reload(), 800); }
        else { toast(`–û—à–∏–±–∫–∞: ${d.error}`, 'error'); btn.disabled = false; btn.textContent = '‚Ü∫ –ü–æ–≤—Ç–æ—Ä'; }
      } catch(e) { toast('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', 'error'); btn.disabled = false; }
    }

    function getCookie(name) {
      const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
      return v ? v[2] : null;
    }

    function applyTheme(theme) {
      document.documentElement.classList.toggle('light', theme === 'light');
      const btn = document.getElementById('themeToggle');
      if (btn) btn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }
    function toggleTheme() {
      const next = (localStorage.getItem('theme') || 'dark') === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    }
    (function() { applyTheme(localStorage.getItem('theme') || 'dark'); })();

    // ‚îÄ‚îÄ –ë—É—Ä–≥–µ—Ä ‚îÄ‚îÄ
    function openNav() {
      document.getElementById('mainNav').classList.add('open');
      document.getElementById('navOverlay').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeNav() {
      document.getElementById('mainNav').classList.remove('open');
      document.getElementById('navOverlay').style.display = 'none';
      document.body.style.overflow = '';
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.nav-item').forEach(function(link) {
        link.addEventListener('click', function() {
          if (window.innerWidth <= 900) closeNav();
        });
      });
    });
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
