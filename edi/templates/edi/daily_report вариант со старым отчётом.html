{% extends 'edi/base.html' %}
{% block title %}–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç ‚Äî {{ report_date|date:"d.m.Y" }}{% endblock %}
{% block page_title %}üìã –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç{% endblock %}
{% block page_sub %}{{ report_date|date:"d.m.Y" }} ¬∑ {{ doc_count }} –∑–∞–∫–∞–∑–æ–≤ ¬∑ {{ place_count }} —Ç–æ—á–µ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏{% endblock %}

{% block topbar_actions %}
<a href="?date={{ report_date|date:'Y-m-d' }}&export=xlsx"
   class="btn btn-primary" style="text-decoration:none">‚¨á –°–∫–∞—á–∞—Ç—å Excel</a>
{% endblock %}

{% block content %}
<div style="max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:16px">

  <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
  <div class="card" style="padding:14px 20px">
    <form method="get" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <label style="font-size:13px;font-weight:600;color:var(--muted)">–î–∞—Ç–∞:</label>
      <input type="date" name="date" value="{{ report_date|date:'Y-m-d' }}"
             style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;
                    background:var(--surface2);color:var(--text);font-size:13px">
      <button type="submit" class="btn btn-secondary btn-sm">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      <a href="?" class="btn btn-secondary btn-sm">–ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å</a>
      <div style="margin-left:auto;display:flex;gap:6px">
        <a href="?date={{ prev_date }}" class="btn btn-secondary btn-sm">‚Üê –ü—Ä–µ–¥.</a>
        <a href="?date={{ next_date }}" class="btn btn-secondary btn-sm">–°–ª–µ–¥. ‚Üí</a>
      </div>
    </form>
  </div>

  {% if place_groups %}

  <!-- –°–≤–æ–¥–∫–∞ -->
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
    <div class="card" style="text-align:center;padding:16px">
      <div style="font-size:28px;font-weight:700;color:var(--accent)">{{ doc_count }}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">–ó–∞–∫–∞–∑–æ–≤</div>
    </div>
    <div class="card" style="text-align:center;padding:16px">
      <div style="font-size:28px;font-weight:700;color:var(--accent)">{{ place_count }}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">–¢–æ—á–µ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
    </div>
    <div class="card" style="text-align:center;padding:16px">
      <div style="font-size:22px;font-weight:700;color:var(--accent)" id="vis-total">
        {{ total_amount|floatformat:2 }}
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">–°—É–º–º–∞ —Å –ù–î–°, ‚Ç∏</div>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <div class="card" style="padding:0;overflow:hidden">

    <!-- –ü–æ–∏—Å–∫ -->
    <div style="padding:12px 18px;border-bottom:1px solid var(--border);
                display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <span class="card-title" style="margin:0">–ü–æ–∑–∏—Ü–∏–∏ –ø–æ —Ç–æ—á–∫–∞–º –¥–æ—Å—Ç–∞–≤–∫–∏</span>
      <input type="text" id="q" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª—É‚Ä¶"
             oninput="filterRows()"
             style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;
                    background:var(--surface2);color:var(--text);font-size:12px;width:280px">
    </div>

    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead>
          <tr style="background:var(--surface2)">
            <th style="padding:10px 14px;text-align:left;border-bottom:2px solid var(--border);
                       font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;white-space:nowrap">
              –ê—Ä—Ç–∏–∫—É–ª
            </th>
            <th style="padding:10px 14px;text-align:left;border-bottom:2px solid var(--border);
                       font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">
              –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
            </th>
            <th style="padding:10px 14px;text-align:right;border-bottom:2px solid var(--border);
                       font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;white-space:nowrap">
              –ö–æ–ª-–≤–æ
            </th>
            <th style="padding:10px 14px;text-align:right;border-bottom:2px solid var(--border);
                       font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;white-space:nowrap">
              –°—É–º–º–∞ —Å –ù–î–°, ‚Ç∏
            </th>
          </tr>
        </thead>
        <tbody>

          {% for group in place_groups %}

          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã ‚Äî –º–µ—Å—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
          <tr class="group-header" data-group="{{ forloop.counter }}">
            <td colspan="4"
                style="padding:10px 14px;background:rgba(37,99,235,.15);
                       border-top:2px solid var(--accent);border-bottom:1px solid var(--border)">
              <div style="font-weight:700;font-size:13px;color:var(--accent)">
                üìç {{ group.place_name }}
              </div>
              {% if group.place_addr %}
              <div style="font-size:11px;color:var(--muted);margin-top:2px">
                {{ group.place_addr }}
              </div>
              {% endif %}
            </td>
          </tr>

          <!-- –°—Ç—Ä–æ–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
          {% for row in group.rows %}
          <tr class="data-row"
              data-group="{{ forloop.parentloop.counter }}"
              data-article="{{ row.article|lower }}"
              data-name="{{ row.name|lower }}"
              data-qty="{{ row.qty }}"
              data-amount="{{ row.amount }}"
              style="{% cycle '' 'background:var(--surface2)' %}">
            <td style="padding:9px 14px;border-bottom:1px solid var(--border);
                       font-family:monospace;font-size:11px;color:var(--muted)">
              {{ row.article|default:"‚Äî" }}
            </td>
            <td style="padding:9px 14px;border-bottom:1px solid var(--border);font-weight:500">
              {{ row.name|default:"‚Äî" }}
            </td>
            <td style="padding:9px 14px;border-bottom:1px solid var(--border);
                       text-align:right;font-family:monospace">
              {{ row.qty|floatformat:0 }}
            </td>
            <td style="padding:9px 14px;border-bottom:1px solid var(--border);
                       text-align:right;font-family:monospace;font-weight:600">
              {{ row.amount|floatformat:2 }}
            </td>
          </tr>
          {% endfor %}

          <!-- –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥ –≥—Ä—É–ø–ø—ã -->
          <tr class="subtotal-row" data-group="{{ forloop.counter }}">
            <td colspan="2"
                style="padding:9px 14px;border-bottom:2px solid var(--border);
                       text-align:right;font-weight:600;font-size:12px;
                       background:rgba(37,99,235,.07);color:var(--accent)">
              –ò—Ç–æ–≥–æ –ø–æ —Ç–æ—á–∫–µ
            </td>
            <td style="padding:9px 14px;border-bottom:2px solid var(--border);
                       text-align:right;font-weight:700;font-family:monospace;
                       background:rgba(37,99,235,.07);color:var(--accent)">
              {{ group.subtotal_qty|floatformat:0 }}
            </td>
            <td style="padding:9px 14px;border-bottom:2px solid var(--border);
                       text-align:right;font-weight:700;font-family:monospace;
                       background:rgba(37,99,235,.07);color:var(--accent)">
              {{ group.subtotal_amount|floatformat:2 }}
            </td>
          </tr>

          {% endfor %}

          <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
          <tr style="background:rgba(37,99,235,.1)">
            <td colspan="2"
                style="padding:13px 14px;text-align:right;font-weight:700;font-size:14px">
              –ò–¢–û–ì–û –ü–û –û–¢–ß–Å–¢–£:
            </td>
            <td id="ft-q"
                style="padding:13px 14px;text-align:right;font-weight:700;
                       font-family:monospace;font-size:14px;color:var(--accent)">
              {{ total_qty|floatformat:0 }}
            </td>
            <td id="ft-s"
                style="padding:13px 14px;text-align:right;font-weight:700;
                       font-family:monospace;font-size:14px;color:var(--accent)">
              {{ total_amount|floatformat:2 }}
            </td>
          </tr>

        </tbody>
      </table>
    </div>
  </div>

  {% else %}
  <div class="card">
    <div class="empty">
      <div class="empty-icon">üì≠</div>
      <p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ {{ report_date|date:"d.m.Y" }}</p>
    </div>
  </div>
  {% endif %}

</div>

<script>
function filterRows() {
  var q = document.getElementById('q').value.toLowerCase().trim();

  // –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º subtotal
  var groups = {};
  document.querySelectorAll('tr.data-row').forEach(function(row) {
    var g   = row.dataset.group;
    var show = !q || row.dataset.name.includes(q) || row.dataset.article.includes(q);
    row.style.display = show ? '' : 'none';
    if (!groups[g]) groups[g] = {qty: 0, amt: 0, visible: 0};
    if (show) {
      groups[g].qty     += parseFloat(row.dataset.qty)    || 0;
      groups[g].amt     += parseFloat(row.dataset.amount) || 0;
      groups[g].visible += 1;
    }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º subtotal –∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä—É–ø–ø—ã
  document.querySelectorAll('tr.subtotal-row').forEach(function(row) {
    var g = row.dataset.group;
    var d = groups[g] || {qty:0, amt:0, visible:0};
    var cells = row.querySelectorAll('td');
    cells[2].textContent = Math.round(d.qty).toLocaleString('ru-RU');
    cells[3].textContent = d.amt.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
  });

  document.querySelectorAll('tr.group-header').forEach(function(row) {
    var g = row.dataset.group;
    var d = groups[g] || {visible:0};
    var hide = q && d.visible === 0;
    row.style.display = hide ? 'none' : '';
    // —Å–∫—Ä—ã–≤–∞–µ–º subtotal —Ç–æ–∂–µ –µ—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –ø—É—Å—Ç–∞—è
    document.querySelectorAll('tr.subtotal-row[data-group="'+g+'"]').forEach(function(sr){
      sr.style.display = hide ? 'none' : '';
    });
  });

  // –û–±—â–∏–π –∏—Ç–æ–≥
  var totalQty = 0, totalAmt = 0;
  Object.values(groups).forEach(function(d){ totalQty += d.qty; totalAmt += d.amt; });
  document.getElementById('ft-q').textContent = Math.round(totalQty).toLocaleString('ru-RU');
  document.getElementById('ft-s').textContent = totalAmt.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
  document.getElementById('vis-total').textContent = totalAmt.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
}
</script>
{% endblock %}
