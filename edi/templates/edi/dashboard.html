{% extends 'edi/base.html' %}
{% load edi_tags %}
{% block title %}–î–∞—à–±–æ—Ä–¥ ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}–î–∞—à–±–æ—Ä–¥{% endblock %}
{% block page_sub %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞ Docrobot ‚Üí 1–°{% endblock %}

{% block topbar_actions %}
<a href="{% url 'reports_export' %}" class="btn btn-secondary">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚îÄ‚îÄ -->
<div class="stats-grid">
  <div class="stat-card" style="--accent-color:var(--accent)">
    <div class="stat-label">–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
    <div class="stat-value blue">{{ total_docs }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--accent2)">
    <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 1–°</div>
    <div class="stat-value green">{{ total_sent }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--warn)">
    <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
    <div class="stat-value warn">{{ pending }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--danger)">
    <div class="stat-label">–û—à–∏–±–∫–∏</div>
    <div class="stat-value red">{{ total_errors }}</div>
  </div>
  {% for type, label in doc_stats.items %}
  <div class="stat-card">
    <div class="stat-label">{{ label }}</div>
    <div class="stat-value">{{ doc_stats|dict_get:type }}</div>
  </div>
  {% endfor %}
</div>

<div class="grid-2 mb24">
  <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã -->
  <div class="table-wrap">
    <div class="table-toolbar flex-between">
      <span style="font-size:12px;font-weight:600;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</span>
      <a href="{% url 'documents' %}" class="btn btn-secondary btn-sm">–í—Å–µ ‚Üí</a>
    </div>
    <table>
      <thead><tr><th>–¢–∏–ø</th><th>–ù–æ–º–µ—Ä</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–æ–ª—É—á–µ–Ω</th></tr></thead>
      <tbody>
        {% for doc in recent_docs %}
        <tr onclick="location.href='{% url 'document_detail' doc.pk %}'" style="cursor:pointer">
          <td><span class="badge badge-{{ doc.doc_type }}">{{ doc.get_doc_type_display }}</span></td>
          <td class="td-mono">{{ doc.number|default:"‚Äî" }}</td>
          <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ doc.supplier_name|default:"‚Äî" }}</td>
          <td>
            {% with q=doc.queue_entry %}
            {% if q %}<span class="badge badge-{{ q.status }}">{{ q.get_status_display }}</span>{% else %}<span class="badge badge-pending">‚Äî</span>{% endif %}
            {% endwith %}
          </td>
          <td class="td-mono">{{ doc.received_at|date:"d.m H:i" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5"><div class="empty"><div class="empty-icon">üì≠</div><p>–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç</p></div></td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π -->
  <div class="card">
    <div class="card-title">–î–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞ 7 –¥–Ω–µ–π</div>
    <div id="week-chart" style="display:flex;align-items:flex-end;gap:6px;height:90px;"></div>
    <div style="margin-top:12px;">
      {% if errors %}
      <div style="font-size:12px;font-weight:600;color:var(--danger);margin-bottom:8px;">‚ö† –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
      {% for e in errors %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
        <div>
          <span class="badge badge-{{ e.document.doc_type }}">{{ e.document.doc_type }}</span>
          <span style="font-family:var(--mono);font-size:11px;margin-left:6px;">{{ e.document.number }}</span>
        </div>
        <button class="btn btn-warn btn-sm" onclick="retryQueue({{ e.id }}, this)">‚Ü∫ –ü–æ–≤—Ç–æ—Ä</button>
      </div>
      {% endfor %}
      {% else %}
      <div style="color:var(--accent2);font-size:12px;">‚úì –û—à–∏–±–æ–∫ –Ω–µ—Ç</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ -->
<div class="table-wrap">
  <div class="table-toolbar flex-between">
    <span style="font-size:12px;font-weight:600;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</span>
    <a href="{% url 'logs' %}" class="btn btn-secondary btn-sm">–í—Å–µ –ª–æ–≥–∏ ‚Üí</a>
  </div>
  <table>
    <thead><tr><th>–í—Ä–µ–º—è</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr></thead>
    <tbody>
      {% for log in recent_logs %}
      <tr>
        <td class="td-mono">{{ log.created_at|date:"d.m H:i:s" }}</td>
        <td><span class="badge badge-{% if log.level == 'error' %}error-lvl{% elif log.level == 'warn' %}warn{% else %}info{% endif %}">{{ log.get_level_display }}</span></td>
        <td class="td-mono">{{ log.action }}</td>
        <td style="font-size:12px;color:var(--text2);">{{ log.message|truncatechars:80 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4"><div class="empty"><div class="empty-icon">üìã</div><p>–õ–æ–≥–æ–≤ –Ω–µ—Ç</p></div></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
const data = {{ seven_days|safe }};
const max  = Math.max(...data.map(d => d.count), 1);
const wrap = document.getElementById('week-chart');
data.forEach(d => {
  const h = Math.max(4, Math.round((d.count / max) * 90));
  wrap.innerHTML += `
    <div style="display:flex;flex-direction:column;align-items:center;flex:1;gap:4px;">
      <div style="font-size:10px;color:var(--text2);">${d.count}</div>
      <div style="width:100%;height:${h}px;background:var(--accent);border-radius:3px 3px 0 0;opacity:0.8;"></div>
      <div style="font-size:9px;color:var(--text3);">${d.day}</div>
    </div>`;
});
</script>
{% endblock %}
