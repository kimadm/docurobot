{% extends 'edi/base.html' %}
{% block title %}–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è{% endblock %}
{% block page_sub %}Docrobot API –∏ 1–° HTTP-—Å–µ—Ä–≤–∏—Å{% endblock %}

{% block extra_head %}
<style>
  .conn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
  .status-ok      { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }
  .status-error   { background: var(--danger);  box-shadow: 0 0 6px var(--danger); }
  .status-unknown { background: #4B5563; }
  .result-ok    { background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.3); color:var(--accent2); border-radius:8px; padding:12px 16px; font-size:13px; margin-top:12px; }
  .result-error { background:rgba(239,68,68,0.08);  border:1px solid rgba(239,68,68,0.3);  color:var(--danger);  border-radius:8px; padding:12px 16px; font-size:13px; margin-top:12px; }
  .result-info  { background:rgba(59,130,246,0.08); border:1px solid rgba(59,130,246,0.3);  color:var(--accent);  border-radius:8px; padding:12px 16px; font-size:13px; margin-top:12px; }
  .field-row { display:flex; flex-direction:column; gap:5px; margin-bottom:14px; }
  .field-row label { font-size:11px; color:var(--text3); font-weight:500; }
  .section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  .section-title { font-size:13px; font-weight:700; color:var(--text1); }
  .tested-at { font-size:10px; color:var(--text3); }
  input[type=password]:not(:placeholder-shown) { letter-spacing: 3px; }
</style>
{% endblock %}

{% block content %}
<form method="post" id="conn-form">
{% csrf_token %}

<div class="conn-grid">

  <!-- ‚îÄ‚îÄ DOCROBOT ‚îÄ‚îÄ -->
  <div class="card">
    <div class="section-header">
      <div>
        <div class="section-title">
          <span class="status-dot {% if cfg.docrobot_status == 'ok' %}status-ok{% elif cfg.docrobot_status == 'error' %}status-error{% else %}status-unknown{% endif %}"></span>
          Docrobot API
        </div>
        {% if cfg.docrobot_tested_at %}
        <div class="tested-at">–ü—Ä–æ–≤–µ—Ä–µ–Ω: {{ cfg.docrobot_tested_at|date:"d.m.Y H:i" }}</div>
        {% endif %}
      </div>
      <button type="button" class="btn btn-secondary btn-sm" onclick="testDocrobot()">‚ñ∂ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    </div>

    <div class="field-row">
      <label>URL API</label>
      <input type="url" name="docrobot_url" id="dr_url" value="{{ cfg.docrobot_url }}" placeholder="https://edi-api.docrobot.kz" />
    </div>
    <div class="field-row">
      <label>–õ–æ–≥–∏–Ω</label>
      <input type="text" name="docrobot_username" id="dr_user" value="{{ cfg.docrobot_username }}" placeholder="Food_Factory" autocomplete="username" />
    </div>
    <div class="field-row">
      <label>–ü–∞—Ä–æ–ª—å {% if cfg.docrobot_password %}<span style="color:var(--accent2);font-size:10px;">‚óè —Å–æ—Ö—Ä–∞–Ω—ë–Ω</span>{% endif %}</label>
      <input type="password" name="docrobot_password" id="dr_pass" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å" autocomplete="current-password" />
    </div>
    <div class="field-row">
      <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ (—Å–µ–∫—É–Ω–¥—ã)</label>
      <input type="number" name="docrobot_poll_interval" value="{{ cfg.docrobot_poll_interval }}" min="10" max="3600" />
    </div>
    <div class="field-row">
      <label>GLN –∫–æ–º–ø–∞–Ω–∏–∏ <span style="color:var(--muted);font-weight:400">(13 —Ü–∏—Ñ—Ä, –≤–∞—à –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ Docrobot)</span></label>
      <input type="text" name="docrobot_gln" value="{{ cfg.docrobot_gln }}" placeholder="9845000099712" maxlength="13" pattern="\d{13}" />
    </div>

    <div id="dr-result"></div>
  </div>

  <!-- ‚îÄ‚îÄ 1–° ‚îÄ‚îÄ -->
  <div class="card">
    <div class="section-header">
      <div>
        <div class="section-title">
          <span class="status-dot {% if cfg.onec_status == 'ok' %}status-ok{% elif cfg.onec_status == 'error' %}status-error{% else %}status-unknown{% endif %}"></span>
          1–° HTTP-—Å–µ—Ä–≤–∏—Å
        </div>
        {% if cfg.onec_tested_at %}
        <div class="tested-at">–ü—Ä–æ–≤–µ—Ä–µ–Ω: {{ cfg.onec_tested_at|date:"d.m.Y H:i" }}</div>
        {% endif %}
      </div>
      <button type="button" class="btn btn-secondary btn-sm" onclick="testOnec()">‚ñ∂ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    </div>

    <div class="field-row">
      <label>URL HTTP-—Å–µ—Ä–≤–∏—Å–∞</label>
      <input type="url" name="onec_url" id="onec_url" value="{{ cfg.onec_url }}" placeholder="http://localhost/hs/docrobot/orders" />
    </div>
    <div class="field-row">
      <label>–õ–æ–≥–∏–Ω (Basic Auth)</label>
      <input type="text" name="onec_username" id="onec_user" value="{{ cfg.onec_username }}" placeholder="–ü—É—Å—Ç–æ –µ—Å–ª–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" autocomplete="username" />
    </div>
    <div class="field-row">
      <label>–ü–∞—Ä–æ–ª—å {% if cfg.onec_password %}<span style="color:var(--accent2);font-size:10px;">‚óè —Å–æ—Ö—Ä–∞–Ω—ë–Ω</span>{% endif %}</label>
      <input type="password" name="onec_password" id="onec_pass" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å" autocomplete="current-password" />
    </div>
    <div class="field-row">
      <label>–¢–∞–π–º–∞—É—Ç (—Å–µ–∫—É–Ω–¥—ã)</label>
      <input type="number" name="onec_timeout" value="{{ cfg.onec_timeout }}" min="5" max="120" />
    </div>

    <div id="onec-result"></div>
  </div>

</div>

<!-- ‚îÄ‚îÄ TELEGRAM ‚îÄ‚îÄ -->
<div class="card" style="margin-top:20px;">
  <div class="section-header">
    <div class="section-title">üì¨ Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <button type="button" class="btn btn-secondary btn-sm" onclick="testTelegram()">‚ñ∂ –¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</button>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
    <div class="field-row">
      <label>Bot Token</label>
      <input type="text" name="telegram_token" value="{{ cfg.telegram_token }}" placeholder="1234567890:AAF..." />
    </div>
    <div class="field-row">
      <label>Chat ID</label>
      <input type="text" name="telegram_chat_id" value="{{ cfg.telegram_chat_id }}" placeholder="-1001234567890" />
    </div>
  </div>
  <div id="tg-result"></div>
</div>

<!-- ‚îÄ‚îÄ –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ë–î ‚îÄ‚îÄ -->
<div class="card" style="margin-top:20px">
  <div class="section-header">
    <div><div class="section-title">üóÑÔ∏è –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</div></div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
    <div>
      <div class="field-row">
        <label>–•—Ä–∞–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã (–¥–Ω–µ–π) <span style="color:var(--muted);font-weight:400">0 = –Ω–µ —É–¥–∞–ª—è—Ç—å</span></label>
        <input type="number" name="cleanup_days" value="{{ cfg.cleanup_days }}" min="0" max="3650" />
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:4px">
        –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å—Ä–æ–∫–∞ –±—É–¥—É—Ç —É–¥–∞–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ –ø–æ–ª–ª–∏–Ω–≥–∞.
      </div>
      <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="cleanupNow()">
        üßπ –û—á–∏—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å
      </button>
    </div>
    <div>
      <div style="font-size:12px;font-weight:600;margin-bottom:8px">–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:12px">
        –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö SQLite. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã.
      </div>
      <a href="{% url 'backup_db' %}" class="btn btn-secondary">
        üíæ –°–∫–∞—á–∞—Ç—å backup –ë–î
      </a>
    </div>
  </div>
  <div id="cleanup-result" style="margin-top:12px"></div>
</div>

<!-- ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ ‚îÄ‚îÄ -->
<div style="display:flex;justify-content:flex-end;gap:12px;margin-top:20px;">
  <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

</form>
{% endblock %}

{% block extra_js %}
<script>
const CSRF = '{{ csrf_token }}';

function showResult(elId, msg, ok, info) {
  const cls = ok ? 'result-ok' : (info ? 'result-info' : 'result-error');
  document.getElementById(elId).innerHTML =
    '<div class="' + cls + '">' + msg + '</div>';
}

async function testDocrobot() {
  showResult('dr-result', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...', false, true);
  try {
    const r = await fetch('/api/test-docrobot/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
      body: JSON.stringify({
        url:      document.getElementById('dr_url').value,
        username: document.getElementById('dr_user').value,
        password: document.getElementById('dr_pass').value,
      }),
    });
    const d = await r.json();
    if (d.success) {
      showResult('dr-result',
        '‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!<br>–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: <code style="font-size:11px;">' + d.token_preview + '</code>',
        true);
    } else {
      showResult('dr-result', '‚úó –û—à–∏–±–∫–∞: ' + (d.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), false);
    }
  } catch(e) { showResult('dr-result', '‚úó –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + e.message, false); }
}

async function testOnec() {
  showResult('onec-result', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', false, true);
  try {
    const r = await fetch('/api/test-onec/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
      body: JSON.stringify({
        url:      document.getElementById('onec_url').value,
        username: document.getElementById('onec_user').value,
        password: document.getElementById('onec_pass').value,
      }),
    });
    const d = await r.json();
    if (d.success) {
      showResult('onec-result',
        '‚úì –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω! HTTP ' + d.http_status +
        (d.note ? '<br><small>' + d.note + '</small>' : '') +
        (d.response ? '<br><code style="font-size:10px;">' + d.response.slice(0,150) + '</code>' : ''),
        true);
    } else {
      showResult('onec-result', '‚úó ' + (d.error || 'HTTP ' + d.http_status), false);
    }
  } catch(e) { showResult('onec-result', '‚úó –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + e.message, false); }
}

async function testTelegram() {
  showResult('tg-result', '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...', false, true);
  const token   = document.querySelector('[name=telegram_token]').value;
  const chat_id = document.querySelector('[name=telegram_chat_id]').value;
  if (!token || !chat_id) {
    showResult('tg-result', '‚úó –£–∫–∞–∂–∏—Ç–µ Bot Token –∏ Chat ID', false); return;
  }
  try {
    const r = await fetch('https://api.telegram.org/bot' + token + '/sendMessage', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id, text: '‚úÖ Docrobot EDI Gateway ‚Äî —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ' }),
    });
    const d = await r.json();
    if (d.ok) {
      showResult('tg-result', '‚úì –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!', true);
    } else {
      showResult('tg-result', '‚úó –û—à–∏–±–∫–∞ Telegram: ' + d.description, false);
    }
  } catch(e) { showResult('tg-result', '‚úó ' + e.message, false); }
}
async function cleanupNow() {
  const res = document.getElementById('cleanup-result');
  res.innerHTML = '<span style="color:var(--muted)">‚è≥ –û—á–∏—Å—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞...</span>';
  try {
    const r = await fetch('/api/cleanup/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}});
    const d = await r.json();
    res.innerHTML = d.ok
      ? '<span style="color:var(--accent2)">‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.</span>'
      : '<span style="color:var(--danger)">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞</span>';
  } catch(e) { res.innerHTML = '<span style="color:var(--danger)">‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</span>'; }
}

function getCookie(n) { const m = document.cookie.match('(^|;)\\s*'+n+'\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
</script>
{% endblock %}
