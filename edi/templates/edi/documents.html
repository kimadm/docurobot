{% extends 'edi/base.html' %}
{% block title %}–î–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}EDI-–¥–æ–∫—É–º–µ–Ω—Ç—ã{% endblock %}
{% block page_sub %}–í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ Docrobot{% endblock %}

{% block content %}
<style>
  .search-wrap { position:relative; margin-bottom:14px; }
  .search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; color:var(--muted); pointer-events:none; }
  #searchInput { width:100%; padding:10px 40px 10px 36px; font-size:14px; background:var(--surface); border:1px solid var(--border); border-radius:10px; color:var(--text); outline:none; transition:border-color .2s; box-sizing:border-box; }
  #searchInput:focus { border-color:var(--accent); }
  .search-spinner { position:absolute; right:12px; top:50%; transform:translateY(-50%); display:none; width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .6s linear infinite; }
  @keyframes spin { to { transform:translateY(-50%) rotate(360deg); } }

  .filters-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
  .filters-row select, .filters-row input[type=date] { padding:7px 10px; font-size:12px; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); outline:none; }
  .filter-btn { padding:7px 14px; font-size:12px; font-weight:600; border:none; border-radius:8px; cursor:pointer; text-decoration:none; }
  .filter-btn-apply { background:var(--accent); color:#fff; }
  .filter-btn-reset { background:var(--surface2); color:var(--muted); }
  .spacer { flex:1; }
  .results-count { font-size:12px; color:var(--muted); }

  .table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  table { width:100%; border-collapse:collapse; font-size:12px; }
  thead th { padding:10px 12px; text-align:left; font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; background:var(--surface2); border-bottom:1px solid var(--border); }
  tbody td { padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:middle; }
  tbody tr:last-child td { border-bottom:none; }
  tbody tr:hover td { background:var(--surface2); }

  .badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:700; }
  .badge-ORDER { background:#EFF6FF; color:#1D4ED8; }
  .badge-ORDRSP { background:#F0FDF4; color:#16A34A; }
  .badge-DESADV { background:#FFF7ED; color:#C2410C; }
  .badge-INVOICE { background:#FDF4FF; color:#9333EA; }
  .badge-PRICAT { background:#F0FDFA; color:#0D9488; }
  .badge-sent { background:#F0FDF4; color:#16A34A; }
  .badge-pending { background:#FFF7ED; color:#D97706; }
  .badge-error { background:#FEF2F2; color:#DC2626; }
  .badge-failed { background:#FEF2F2; color:#991B1B; }
  .badge-sending { background:#EFF6FF; color:#2563EB; }
  .badge-none { background:var(--surface2); color:var(--muted); }

  .td-mono { font-family:monospace; font-size:11px; color:var(--muted); }
  .td-num { font-weight:600; }
  .actions { display:flex; gap:4px; }
  .btn-sm { padding:4px 10px; font-size:11px; font-weight:600; border-radius:6px; cursor:pointer; text-decoration:none; border:none; }
  .btn-detail { background:var(--surface2); color:var(--text); }
  .btn-retry { background:rgba(245,158,11,.12); color:#D97706; }
  mark { background:rgba(250,204,21,.4); border-radius:2px; padding:0 1px; }
  .empty { text-align:center; padding:48px; color:var(--muted); }
  .empty-icon { font-size:40px; margin-bottom:10px; }
</style>

<div class="search-wrap">
  <span class="search-icon">üîç</span>
  <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, GLN, –ø–æ—Å—Ç–∞–≤—â–∏–∫—É, –ø–æ–∫—É–ø–∞—Ç–µ–ª—é..." value="{{ filters.q }}" autocomplete="off">
  <div class="search-spinner" id="searchSpinner"></div>
</div>

<form method="get" id="filterForm" class="filters-row">
  <select name="type" id="typeSelect">
    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
    {% for val, label in doc_types %}
    <option value="{{ val }}" {% if filters.type == val %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <input type="date" name="date_from" id="dateFrom" value="{{ filters.date_from }}" title="–î–∞—Ç–∞ —Å">
  <input type="date" name="date_to" id="dateTo" value="{{ filters.date_to }}" title="–î–∞—Ç–∞ –ø–æ">
  <input type="hidden" name="q" id="hiddenQ" value="{{ filters.q }}">
  <button type="submit" class="filter-btn filter-btn-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  <a href="{% url 'documents' %}" class="filter-btn filter-btn-reset">–°–±—Ä–æ—Å</a>
  <div class="spacer"></div>
  <span class="results-count">–ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="countNum">{{ documents|length }}</strong></span>

</form>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>–¢–∏–ø</th><th>–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
        <th>–ü–æ–ª—É—á–µ–Ω</th><th></th>
      </tr>
    </thead>
    <tbody id="tableBody">
      {% for doc in documents %}
      <tr>
        <td><span class="badge badge-{{ doc.doc_type }}">{{ doc.doc_type }}</span></td>
        <td class="td-num">{{ doc.number|default:"‚Äî" }}</td>
        <td class="td-mono">{{ doc.doc_date|date:"d.m.Y"|default:"‚Äî" }}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ doc.supplier_name }}">{{ doc.supplier_name|default:doc.supplier_gln|default:"‚Äî" }}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ doc.buyer_name }}">{{ doc.buyer_name|default:doc.buyer_gln|default:"‚Äî" }}</td>
        <td class="td-mono">{{ doc.received_at|date:"d.m.Y H:i" }}</td>
        <td><div class="actions">
          <a href="{% url 'document_detail' doc.pk %}" class="btn-sm btn-detail">–î–µ—Ç–∞–ª–∏</a>
        </div></td>
      </tr>
      {% empty %}
      <tr><td colspan="7"><div class="empty"><div class="empty-icon">üì≠</div><p>–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{# ‚îÄ‚îÄ –ü–∞–≥–∏–Ω–∞—Ü–∏—è ‚îÄ‚îÄ #}
{% if page_obj.has_other_pages %}
<div style="display:flex;align-items:center;justify-content:space-between;margin-top:16px;font-size:13px;">
  <div style="color:var(--muted)">
    –ü–æ–∫–∞–∑–∞–Ω–æ {{ page_obj.start_index }}‚Äì{{ page_obj.end_index }} –∏–∑ <strong>{{ total }}</strong> –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  </div>
  <div style="display:flex;gap:4px;align-items:center">
    {% if page_obj.has_previous %}
    <a href="?{% if filters.type %}type={{ filters.type }}&{% endif %}{% if filters.q %}q={{ filters.q }}&{% endif %}{% if filters.date_from %}date_from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}date_to={{ filters.date_to }}&{% endif %}page={{ page_obj.previous_page_number }}"
       style="padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;text-decoration:none;color:var(--text)">‚Üê –ù–∞–∑–∞–¥</a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <span style="padding:6px 12px;background:var(--accent);border-radius:8px;color:#fff;font-weight:600">{{ num }}</span>
      {% elif num >= page_obj.number|add:"-3" and num <= page_obj.number|add:"3" %}
        <a href="?{% if filters.type %}type={{ filters.type }}&{% endif %}{% if filters.q %}q={{ filters.q }}&{% endif %}{% if filters.date_from %}date_from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}date_to={{ filters.date_to }}&{% endif %}page={{ num }}"
           style="padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;text-decoration:none;color:var(--text)">{{ num }}</a>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <a href="?{% if filters.type %}type={{ filters.type }}&{% endif %}{% if filters.q %}q={{ filters.q }}&{% endif %}{% if filters.date_from %}date_from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}date_to={{ filters.date_to }}&{% endif %}page={{ page_obj.next_page_number }}"
       style="padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;text-decoration:none;color:var(--text)">–í–ø–µ—Ä—ë–¥ ‚Üí</a>
    {% endif %}
  </div>
</div>
{% else %}
<div style="text-align:right;margin-top:10px;font-size:12px;color:var(--muted)">
  –í—Å–µ–≥–æ: <strong>{{ total }}</strong> –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
</div>
{% endif %}

<script>
const searchInput = document.getElementById('searchInput');
const tableBody   = document.getElementById('tableBody');
const spinner     = document.getElementById('searchSpinner');
const countNum    = document.getElementById('countNum');
let searchTimer = null, lastQuery = '';

searchInput.addEventListener('input', function() {
  const q = this.value.trim();
  document.getElementById('hiddenQ').value = q;
  clearTimeout(searchTimer);
  if (q === lastQuery) return;
  searchTimer = setTimeout(() => doSearch(q), 300);
});

function doSearch(q) {
  lastQuery = q;
  spinner.style.display = 'block';
  const type = document.getElementById('typeSelect').value;
  const params = new URLSearchParams({ q, type, limit: 100 });
  fetch('/api/search/?' + params)
    .then(r => r.json())
    .then(data => { spinner.style.display = 'none'; renderResults(data.results, q); countNum.textContent = data.shown; })
    .catch(() => { spinner.style.display = 'none'; });
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function hi(text, q) {
  if (!q) return esc(text);
  return esc(text).replace(new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi'), '<mark>$1</mark>');
}

function renderResults(results, q) {
  if (!results.length) {
    tableBody.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="empty-icon">üîç</div><p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É ¬´${esc(q)}¬ª</p></div></td></tr>`;
    return;
  }
  tableBody.innerHTML = results.map(d => `<tr>
    <td><span class="badge badge-${d.doc_type}">${d.doc_type}</span></td>
    <td class="td-num">${hi(d.number, q)}</td>
    <td class="td-mono">${d.doc_date}</td>
    <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${hi(d.supplier_name !== '‚Äî' ? d.supplier_name : d.supplier_gln, q)}</td>
    <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${hi(d.buyer_name !== '‚Äî' ? d.buyer_name : d.buyer_gln, q)}</td>
    <td><span class="badge badge-${d.status}">${d.status_label}</span></td>
    <td class="td-mono" style="text-align:center">‚Äî</td>
    <td class="td-mono">${d.received_at}</td>
    <td><div class="actions"><a href="${d.url}" class="btn-sm btn-detail">–î–µ—Ç–∞–ª–∏</a></div></td>
  </tr>`).join('');
}


function getCookie(n) { const m = document.cookie.match('(^|;)\\s*' + n + '\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
</script>
{% endblock %}
