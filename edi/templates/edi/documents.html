{% extends 'edi/base.html' %}
{% block title %}–î–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}EDI-–¥–æ–∫—É–º–µ–Ω—Ç—ã{% endblock %}
{% block page_sub %}–í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ Docrobot{% endblock %}

{% block content %}
<div class="table-wrap">
  <div class="table-toolbar">
    <form method="get" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%">
      <input type="search" name="q" value="{{ filters.q }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, –ø–æ—Å—Ç–∞–≤—â–∏–∫—É..." style="width:220px" />
      <select name="type">
        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
        {% for val, label in doc_types %}
        <option value="{{ val }}" {% if filters.type == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <input type="date" name="date_from" value="{{ filters.date_from }}" title="–î–∞—Ç–∞ —Å" />
      <input type="date" name="date_to" value="{{ filters.date_to }}" title="–î–∞—Ç–∞ –ø–æ" />
      <button type="submit" class="btn btn-primary btn-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <a href="{% url 'documents' %}" class="btn btn-secondary btn-sm">–°–±—Ä–æ—Å</a>
      <div style="flex:1"></div>
      <a href="{% url 'reports_export' %}" class="btn btn-secondary btn-sm">‚¨á CSV</a>
    </form>
  </div>
  <table>
    <thead>
      <tr>
        <th>–¢–∏–ø</th><th>–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
        <th>–°—Ç–∞—Ç—É—Å 1–°</th><th>–ü–æ–ø—ã—Ç–æ–∫</th><th>–ü–æ–ª—É—á–µ–Ω</th><th></th>
      </tr>
    </thead>
    <tbody>
      {% for doc in documents %}
      <tr>
        <td><span class="badge badge-{{ doc.doc_type }}">{{ doc.get_doc_type_display }}</span></td>
        <td class="td-mono">{{ doc.number|default:"‚Äî" }}</td>
        <td class="td-mono">{{ doc.doc_date|default:"‚Äî" }}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ doc.supplier_name }}">{{ doc.supplier_name|default:"‚Äî" }}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ doc.buyer_name }}">{{ doc.buyer_name|default:"‚Äî" }}</td>
        <td>
          {% with q=doc.queue_entry %}
          {% if q %}<span class="badge badge-{{ q.status }}">{{ q.get_status_display }}</span>{% else %}‚Äî{% endif %}
          {% endwith %}
        </td>
        <td class="td-mono">
          {% with q=doc.queue_entry %}{% if q %}{{ q.attempts }}{% else %}‚Äî{% endif %}{% endwith %}
        </td>
        <td class="td-mono">{{ doc.received_at|date:"d.m.Y H:i" }}</td>
        <td>
          <div style="display:flex;gap:6px;">
            <a href="{% url 'document_detail' doc.pk %}" class="btn btn-secondary btn-sm">–î–µ—Ç–∞–ª–∏</a>
            {% with q=doc.queue_entry %}
            {% if q and q.status != 'sent' %}
            <button class="btn btn-warn btn-sm" onclick="retryQueue({{ q.id }}, this)">‚Ü∫</button>
            {% endif %}
            {% endwith %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="9"><div class="empty"><div class="empty-icon">üì≠</div><p>–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
