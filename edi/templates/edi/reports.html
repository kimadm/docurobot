{% extends 'edi/base.html' %}
{% block title %}–û—Ç—á—ë—Ç—ã ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}–û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}
{% block page_sub %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞{% endblock %}

{% block topbar_actions %}
<form method="get" style="display:flex;gap:8px;align-items:center;">
  <select name="days" onchange="this.form.submit()" style="font-size:12px;">
    <option value="7"  {% if days == 7  %}selected{% endif %}>7 –¥–Ω–µ–π</option>
    <option value="30" {% if days == 30 %}selected{% endif %}>30 –¥–Ω–µ–π</option>
    <option value="90" {% if days == 90 %}selected{% endif %}>90 –¥–Ω–µ–π</option>
  </select>
</form>
<a href="{% url 'reports_export' %}?days={{ days }}" class="btn btn-success">‚¨á –°–∫–∞—á–∞—Ç—å CSV</a>
{% endblock %}

{% block content %}

<!-- –°–≤–æ–¥–Ω—ã–µ —á–∏—Å–ª–∞ -->
<div class="stats-grid mb24">
  <div class="stat-card" style="--accent-color:var(--accent)">
    <div class="stat-label">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
    <div class="stat-value blue">{{ total_period }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--accent2)">
    <div class="stat-label">–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
    <div class="stat-value green">{{ sent_count }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--warn)">
    <div class="stat-label">–° –æ—à–∏–±–∫–æ–π (–ø–æ–≤—Ç–æ—Ä)</div>
    <div class="stat-value warn">{{ error_count }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--danger)">
    <div class="stat-label">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</div>
    <div class="stat-value red">{{ failed_count }}</div>
  </div>
</div>

<div class="grid-2 mb24">
  <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º -->
  <div class="card">
    <div class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º</div>
    <div id="daily-chart" style="display:flex;align-items:flex-end;gap:3px;height:100px;"></div>
    <div id="daily-labels" style="display:flex;gap:3px;margin-top:4px;"></div>
  </div>

  <!-- –ü–æ —Ç–∏–ø–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
  <div class="card">
    <div class="card-title">–ü–æ —Ç–∏–ø–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
    {% for row in by_type %}
    {% with max_cnt=by_type.0.cnt %}
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span class="badge badge-{{ row.doc_type }}" style="width:70px;justify-content:center;">{{ row.doc_type }}</span>
      <div style="flex:1;background:var(--surface2);border-radius:3px;height:20px;overflow:hidden;">
        <div style="width:{% widthratio row.cnt max_cnt 100 %}%;height:100%;background:var(--accent);border-radius:3px;opacity:0.8;"></div>
      </div>
      <span style="font-family:var(--mono);font-size:13px;font-weight:600;width:32px;">{{ row.cnt }}</span>
    </div>
    {% endwith %}
    {% empty %}
    <div class="empty"><div class="empty-icon">üìä</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</p></div>
    {% endfor %}
  </div>
</div>

<!-- –¢–æ–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ -->
<div class="table-wrap">
  <div class="table-toolbar">
    <span style="font-size:12px;font-weight:600;">–¢–æ–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∑–∞ {{ days }} –¥–Ω–µ–π</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–î–æ–∫—É–º–µ–Ω—Ç–æ–≤</th><th>–î–æ–ª—è</th></tr></thead>
    <tbody>
      {% for s in top_suppliers %}
      <tr>
        <td class="td-mono">{{ forloop.counter }}</td>
        <td>{{ s.supplier_name|default:"(–Ω–µ —É–∫–∞–∑–∞–Ω)" }}</td>
        <td class="td-mono" style="color:var(--accent);font-weight:600;">{{ s.cnt }}</td>
        <td>
          {% if total_period %}
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:80px;background:var(--surface2);border-radius:3px;height:6px;">
              <div style="width:{% widthratio s.cnt total_period 100 %}%;height:100%;background:var(--accent);border-radius:3px;"></div>
            </div>
            <span class="td-mono">{% widthratio s.cnt total_period 100 %}%</span>
          </div>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="4"><div class="empty"><div class="empty-icon">üìà</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p></div></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
const daily = {{ daily_json|safe }};
const maxCnt = Math.max(...daily.map(d => d.count), 1);
const chartEl  = document.getElementById('daily-chart');
const labelsEl = document.getElementById('daily-labels');

daily.forEach(d => {
  const h = Math.max(3, Math.round((d.count / maxCnt) * 100));
  const errH = d.errors > 0 ? Math.max(2, Math.round((d.errors / maxCnt) * 100)) : 0;
  chartEl.innerHTML += `
    <div style="display:flex;flex-direction:column;align-items:center;flex:1;gap:0;justify-content:flex-end;">
      <div style="font-size:9px;color:var(--text2);margin-bottom:2px;">${d.count || ''}</div>
      <div style="width:100%;display:flex;flex-direction:column;gap:0;">
        ${errH ? `<div style="width:100%;height:${errH}px;background:var(--danger);opacity:0.6;border-radius:2px 2px 0 0;" title="${d.errors} –æ—à–∏–±–æ–∫"></div>` : ''}
        <div style="width:100%;height:${h}px;background:var(--accent);opacity:0.8;${errH ? '' : 'border-radius:2px 2px 0 0;'}"></div>
      </div>
    </div>`;
  labelsEl.innerHTML += `<div style="flex:1;text-align:center;font-size:9px;color:var(--text3);">${d.day}</div>`;
});
</script>
{% endblock %}
