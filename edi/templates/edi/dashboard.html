{% extends 'edi/base.html' %}
{% load edi_tags %}
{% block title %}–î–∞—à–±–æ—Ä–¥ ‚Äî Docrobot EDI{% endblock %}
{% block page_title %}–î–∞—à–±–æ—Ä–¥{% endblock %}
{% block page_sub %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞ Docrobot ‚Üí 1–°{% endblock %}

{% block topbar_actions %}
<button class="btn btn-primary" id="pollNowBtn" onclick="pollNow()">‚ö° –ü–æ–ª—É—á–∏—Ç—å —Å–µ–π—á–∞—Å</button>
<a href="{% url 'healthcheck' %}" class="btn btn-secondary">ü©∫ –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</a>
<a href="{% url 'reports_export' %}" class="btn btn-secondary">‚¨á CSV</a>
{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚îÄ‚îÄ -->
<div class="stats-grid">
  <div class="stat-card" style="--accent-color:var(--accent)">
    <div class="stat-label">–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
    <div class="stat-value blue" id="rt-total">{{ total_docs }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--accent2)">
    <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 1–°</div>
    <div class="stat-value green" id="rt-sent">{{ total_sent }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--warn)">
    <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
    <div class="stat-value warn" id="rt-pending">{{ pending }}</div>
  </div>
  <div class="stat-card" style="--accent-color:var(--danger)">
    <div class="stat-label">–û—à–∏–±–∫–∏</div>
    <div class="stat-value red" id="rt-errors">{{ total_errors }}</div>
  </div>
  {% for type, label in doc_stats.items %}
  <div class="stat-card">
    <div class="stat-label">{{ label }}</div>
    <div class="stat-value">{{ doc_stats|dict_get:type }}</div>
  </div>
  {% endfor %}
</div>

<div class="grid-2 mb24">
  <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã -->
  <div class="table-wrap">
    <div class="table-toolbar flex-between">
      <span style="font-size:12px;font-weight:600;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</span>
      <a href="{% url 'documents' %}" class="btn btn-secondary btn-sm">–í—Å–µ ‚Üí</a>
    </div>
    <table>
      <thead><tr><th>–¢–∏–ø</th><th>–ù–æ–º–µ—Ä</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–æ–ª—É—á–µ–Ω</th></tr></thead>
      <tbody>
        {% for doc in recent_docs %}
        <tr onclick="location.href='{% url 'document_detail' doc.pk %}'" style="cursor:pointer">
          <td><span class="badge badge-{{ doc.doc_type }}">{{ doc.get_doc_type_display }}</span></td>
          <td class="td-mono">{{ doc.number|default:"‚Äî" }}</td>
          <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ doc.supplier_name|default:"‚Äî" }}</td>
          <td>
            {% with q=doc.queue_entry %}
            {% if q %}<span class="badge badge-{{ q.status }}">{{ q.get_status_display }}</span>{% else %}<span class="badge badge-pending">‚Äî</span>{% endif %}
            {% endwith %}
          </td>
          <td class="td-mono">{{ doc.received_at|date:"d.m H:i" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5"><div class="empty"><div class="empty-icon">üì≠</div><p>–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç</p></div></td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π -->
  <div class="card">
    <div class="card-title">–î–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞ 7 –¥–Ω–µ–π</div>
    <div id="week-chart" style="display:flex;align-items:flex-end;gap:6px;height:90px;"></div>
    <div style="margin-top:12px;">
      {% if errors %}
      <div style="font-size:12px;font-weight:600;color:var(--danger);margin-bottom:8px;">‚ö† –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
      {% for e in errors %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
        <div>
          <span class="badge badge-{{ e.document.doc_type }}">{{ e.document.doc_type }}</span>
          <span style="font-family:var(--mono);font-size:11px;margin-left:6px;">{{ e.document.number }}</span>
        </div>
        <button class="btn btn-warn btn-sm" onclick="retryQueue({{ e.id }}, this)">‚Ü∫ –ü–æ–≤—Ç–æ—Ä</button>
      </div>
      {% endfor %}
      {% else %}
      <div style="color:var(--accent2);font-size:12px;">‚úì –û—à–∏–±–æ–∫ –Ω–µ—Ç</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ -->
<div class="table-wrap">
  <div class="table-toolbar flex-between">
    <span style="font-size:12px;font-weight:600;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</span>
    <a href="{% url 'logs' %}" class="btn btn-secondary btn-sm">–í—Å–µ –ª–æ–≥–∏ ‚Üí</a>
  </div>
  <table>
    <thead><tr><th>–í—Ä–µ–º—è</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr></thead>
    <tbody id="rt-logs">
      {% for log in recent_logs %}
      <tr>
        <td class="td-mono">{{ log.created_at|date:"d.m H:i:s" }}</td>
        <td><span class="badge badge-{% if log.level == 'error' %}error-lvl{% elif log.level == 'warn' %}warn{% else %}info{% endif %}">{{ log.get_level_display }}</span></td>
        <td class="td-mono">{{ log.action }}</td>
        <td style="font-size:12px;color:var(--text2);">{{ log.message|truncatechars:80 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4"><div class="empty"><div class="empty-icon">üìã</div><p>–õ–æ–≥–æ–≤ –Ω–µ—Ç</p></div></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫ –∑–∞ 7 –¥–Ω–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const data = {{ seven_days|safe }};
const max  = Math.max(...data.map(d => d.count), 1);
const wrap = document.getElementById('week-chart');
data.forEach(d => {
  const h = Math.max(4, Math.round((d.count / max) * 90));
  wrap.innerHTML += `
    <div style="display:flex;flex-direction:column;align-items:center;flex:1;gap:4px;">
      <div style="font-size:10px;color:var(--text2);">${d.count}</div>
      <div style="width:100%;height:${h}px;background:var(--accent);border-radius:3px 3px 0 0;opacity:0.8;"></div>
      <div style="font-size:9px;color:var(--text3);">${d.day}</div>
    </div>`;
});

// ‚îÄ‚îÄ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastDocCount = {{ total_docs }};

function refreshStats() {
  fetch('/api/dashboard/stats/')
    .then(r => r.json())
    .then(d => {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
      const totalEl = document.getElementById('rt-total');
      const sentEl  = document.getElementById('rt-sent');
      const errEl   = document.getElementById('rt-errors');
      const pendEl  = document.getElementById('rt-pending');
      const timeEl  = document.getElementById('rt-time');

      if (totalEl) totalEl.textContent = d.total_docs;
      if (sentEl)  sentEl.textContent  = d.total_sent;
      if (errEl)   errEl.textContent   = d.total_errors;
      if (pendEl)  pendEl.textContent  = d.pending;
      if (timeEl)  timeEl.textContent  = d.server_time;

      // –ù–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî –º–∏–≥–∞–µ–º
      if (d.total_docs > lastDocCount) {
        const diff = d.total_docs - lastDocCount;
        showNotification(`üì• –ù–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${diff}`);
        document.title = `(${diff} new) Docrobot EDI`;
        setTimeout(() => document.title = 'Docrobot EDI Gateway', 5000);
        lastDocCount = d.total_docs;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
      const logsBody = document.getElementById('rt-logs');
      if (logsBody && d.last_logs.length) {
        logsBody.innerHTML = d.last_logs.map(l => `
          <tr>
            <td class="td-mono">${l.time}</td>
            <td><span class="badge badge-${l.level === 'error' ? 'error-lvl' : l.level === 'warn' ? 'warn' : 'info'}">${l.level}</span></td>
            <td class="td-mono">${l.action}</td>
            <td style="font-size:12px;">${l.message}</td>
          </tr>`).join('');
      }
    })
    .catch(() => {});
}

function showNotification(text) {
  const el = document.createElement('div');
  el.textContent = text;
  el.style.cssText = `
    position:fixed;top:20px;right:20px;z-index:9999;
    background:#1E3A5F;color:#fff;padding:12px 20px;
    border-radius:10px;font-size:13px;font-weight:600;
    box-shadow:0 4px 16px rgba(0,0,0,.3);
    animation:slideIn .3s ease;
  `;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
setInterval(refreshStats, 30000);

// ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ ¬´–ü–æ–ª—É—á–∏—Ç—å —Å–µ–π—á–∞—Å¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pollNow() {
  const btn = document.getElementById("pollNowBtn");
  btn.disabled = true;
  btn.textContent = "‚è≥ –û–ø—Ä–∞—à–∏–≤–∞–µ–º...";

  fetch("/api/poll-now/", {
    method: "POST",
    headers: {"X-CSRFToken": getCookie("csrftoken")}
  })
  .then(r => r.json())
  .then(d => {
    btn.textContent = "‚úì –ó–∞–ø—É—â–µ–Ω–æ";
    showNotification("üîÑ –ü–æ–ª–ª–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...");
    // –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    setTimeout(() => {
      refreshStats();
      btn.disabled = false;
      btn.textContent = "‚ö° –ü–æ–ª—É—á–∏—Ç—å —Å–µ–π—á–∞—Å";
    }, 5000);
  })
  .catch(() => {
    btn.disabled = false;
    btn.textContent = "‚ö° –ü–æ–ª—É—á–∏—Ç—å —Å–µ–π—á–∞—Å";
    showNotification("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞");
  });
}

function getCookie(n) {
  const m = document.cookie.match("(^|;)\s*" + n + "\s*=\s*([^;]+)");
  return m ? m.pop() : "";
}
</script>
{% endblock %}
